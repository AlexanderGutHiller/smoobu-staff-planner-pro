
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<title>Admin - Einsätze</title>
<style>
  .filter-input { width: 160px; }
  thead input, thead select { font-size: .875rem; padding: .25rem .5rem; }
  .small-muted { color:#6c757d; font-style: italic; font-size: .9em; }
</style>
</head>
<body class="bg-light"><div class="container py-4">
<h1 class="mb-3">Einsätze</h1>

<div class="d-flex gap-2 mb-3 flex-wrap align-items-center">
  <a class="btn btn-outline-secondary" href="/admin/{{ token }}/staff"><i class="bi bi-people"></i> Team</a>
  <a class="btn btn-outline-secondary" href="/admin/{{ token }}/apartments"><i class="bi bi-building"></i> Apartments</a>
  <a class="btn btn-primary" href="/admin/{{ token }}/import"><i class="bi bi-arrow-repeat"></i> Import jetzt</a>
  <a class="btn btn-outline-warning" href="/admin/{{ token }}/cleanup"><i class="bi bi-trash"></i> Bereinigen</a>
  <select class="form-select form-select-sm" style="width: auto;" onchange="setLanguage(this.value)">
    <option value="de" {% if lang == 'de' %}selected{% endif %}>🇩🇪 Deutsch</option>
    <option value="en" {% if lang == 'en' %}selected{% endif %}>🇬🇧 English</option>
    <option value="fr" {% if lang == 'fr' %}selected{% endif %}>🇫🇷 Français</option>
    <option value="it" {% if lang == 'it' %}selected{% endif %}>🇮🇹 Italiano</option>
    <option value="es" {% if lang == 'es' %}selected{% endif %}>🇪🇸 Español</option>
    <option value="ro" {% if lang == 'ro' %}selected{% endif %}>🇷🇴 Română</option>
    <option value="ru" {% if lang == 'ru' %}selected{% endif %}>🇷🇺 Русский</option>
    <option value="bg" {% if lang == 'bg' %}selected{% endif %}>🇧🇬 Български</option>
  </select>
</div>
<script>
function setLanguage(lang) {
  const currentPath = window.location.pathname + window.location.search;
  window.location.href = `/set-language?lang=${lang}&redirect=${encodeURIComponent(currentPath)}`;
}
</script>

<table id="task-table" class="table table-sm table-hover bg-white align-middle">
<thead>
  <tr>
    <th>Datum<br>
      <select id="f-date" class="form-select form-select-sm filter-input">
        <option value="">Alle</option>
        <option value="today">Heute</option>
        <option value="week">Diese Woche</option>
        <option value="month">Dieser Monat</option>
        <option value="next7">Nächste 7 Tage</option>
      </select>
    </th>
    <th>Apartment<br>
      <select id="f-apt" class="form-select form-select-sm filter-input">
        <option value="">Alle</option>
        {% for apt in apartments %}
          <option value="{{ apt.name }}">{{ apt.name }}</option>
        {% endfor %}
      </select>
    </th>
    <th>Geplant</th>
    <th>Status</th>
    <th>Tatsächlich</th>
    <th>Next Arrival</th>
    <th>MA<br>
      <select id="f-staff" class="form-select form-select-sm filter-input">
        <option value="">Alle</option>
        {% for s in staff %}
          <option value="{{ s.name }}">{{ s.name }}</option>
        {% endfor %}
      </select>
    </th>
    <th>Lock</th>
    <th>#</th>
  </tr>
</thead>
<tbody>
{% for t in tasks %}
<tr class="{% if t.assigned_staff_id %}table-success{% else %}table-warning{% endif %}">
  <td data-col="date">{{ t.date | date_wd_de('short') }}</td>
  <td data-col="apt">
    <div class="fw-bold">{{ apt_map.get(t.apartment_id, t.apartment_id) }}</div>
    {% if t.booking_id and book_map.get(t.booking_id) %}
      <div class="small text-primary"><i class="bi bi-person"></i> <strong>{{ book_map.get(t.booking_id, '') }}</strong></div>
    {% endif %}
    {% if t.booking_id and booking_details_map.get(t.booking_id) %}
      <div class="small text-muted">
        <i class="bi bi-people"></i> {{ booking_details_map[t.booking_id].adults }} Erw.
        {% if booking_details_map[t.booking_id].children > 0 %}
          + {{ booking_details_map[t.booking_id].children }} Kinder
        {% endif %}
      </div>
    {% endif %}
    {% if t.notes %}<div class="mt-1"><small class="text-muted"><i class="bi bi-sticky"></i> {{ t.notes }}</small></div>{% endif %}
  </td>
  <td data-col="planned">{{ t.planned_minutes }} min</td>
  <td>
    {% if t.status == 'done' %}
      <span class="badge bg-success"><i class="bi bi-check-circle"></i> Erledigt</span>
    {% elif t.status == 'running' %}
      <span class="badge bg-primary"><i class="bi bi-play-circle"></i> Läuft</span>
    {% else %}
      <span class="badge bg-secondary"><i class="bi bi-hourglass-split"></i> Offen</span>
    {% endif %}
  </td>
  <td>
    {% set tl = timelog_map.get(t.id, {}) %}
    {% if tl.actual_minutes %}
      <span class="fw-bold {% if tl.actual_minutes > t.planned_minutes %}text-danger{% elif tl.actual_minutes > t.planned_minutes * 0.8 %}text-warning{% else %}text-success{% endif %}">
        {{ tl.actual_minutes }} min
      </span>
      {% if tl.actual_minutes > t.planned_minutes %}
        <small class="text-danger d-block">+{{ tl.actual_minutes - t.planned_minutes }} min</small>
      {% endif %}
    {% elif tl.started_at and not tl.ended_at %}
      <span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> Läuft...</span>
    {% else %}
      <span class="text-muted">-</span>
    {% endif %}
  </td>
  <td data-col="next">
    {% if t.next_arrival %}
      <div class="fw-bold">{{ t.next_arrival | date_wd_de('short') }}</div>
      <div class="small">
        <i class="bi bi-people"></i> {{ t.next_arrival_adults or 0 }} Erw.
        {% if t.next_arrival_children and t.next_arrival_children > 0 %}
          + {{ t.next_arrival_children }} Kind
        {% endif %}
      </div>
      {% if t.next_arrival_guest_name %}
        <div class="small text-primary"><i class="bi bi-person"></i> {{ t.next_arrival_guest_name }}</div>
      {% endif %}
      {% if t.next_arrival_comments %}
        <div class="small text-muted"><i class="bi bi-chat-text"></i> {{ t.next_arrival_comments[:60] }}</div>
      {% endif %}
    {% else %}-{% endif %}
  </td>
  <td data-col="staff">
    <form method="post" action="/admin/{{ token }}/task/assign" class="assign-form" id="assign-form-{{ t.id }}">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <select name="staff_id_raw" class="form-select form-select-sm" onchange="document.getElementById('assign-form-{{ t.id }}').submit()">
        <option value="">–</option>
        {% for s in staff %}
          <option value="{{ s.id }}" {% if t.assigned_staff_id==s.id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
    </form>
  </td>
  <td>
    <form method="post" action="/admin/{{ token }}/task/lock">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <input type="hidden" name="lock" value="{{ 0 if t.locked else 1 }}"/>
      <button class="btn btn-sm {{ 'btn-success' if t.locked else 'btn-outline-secondary' }}">
        {% if t.locked %}<i class="bi bi-lock-fill"></i>{% else %}<i class="bi bi-unlock"></i>{% endif %}
      </button>
    </form>
  </td>
  <td><small>#{{ t.id }}</small></td>
</tr>
{% endfor %}
</tbody></table>
<script>
const rows = Array.from(document.querySelectorAll("#task-table tbody tr"));
const today = new Date().toISOString().split('T')[0];

function matchesDateFilter(taskDate, filter) {
  if (!filter) return true;
  const [day, month, year] = taskDate.split('.');
  const taskDateIso = `${year}-${month}-${day}`;
  const todayObj = new Date(today);
  
  switch(filter) {
    case 'today':
      return taskDateIso === today;
    case 'week':
      const weekStart = new Date(todayObj.setDate(todayObj.getDate() - todayObj.getDay()));
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);
      const taskDateObj = new Date(taskDateIso);
      return taskDateObj >= weekStart && taskDateObj <= weekEnd;
    case 'month':
      return taskDateIso.startsWith(today.substring(0, 7));
    case 'next7':
      const next7 = new Date(today);
      next7.setDate(next7.getDate() + 7);
      const taskDateObj2 = new Date(taskDateIso);
      return taskDateObj2 >= new Date(today) && taskDateObj2 <= next7;
    default:
      return true;
  }
}

function applyFilter(){
  const fDate = document.getElementById('f-date').value;
  const fApt = document.getElementById('f-apt').value;
  const fStaff = document.getElementById('f-staff').value;
  const fLock = document.getElementById('f-lock').value;
  
  rows.forEach(tr => {
    const dateTxt = tr.querySelector('[data-col="date"]').innerText;
    const aptTxt = tr.querySelector('[data-col="apt"]').innerText;
    const staffTxt = tr.querySelector('[data-col="staff"]').innerText;
    
    let lockEl = tr.querySelector('[name="lock"]');
    const isLocked = lockEl && lockEl.value === '1';
    
    const ok = matchesDateFilter(dateTxt, fDate)
            && (!fApt || aptTxt.toLowerCase().includes(fApt.toLowerCase()))
            && (!fStaff || staffTxt.toLowerCase().includes(fStaff.toLowerCase()))
            && (!fLock || (fLock === 'locked' && isLocked) || (fLock === 'unlocked' && !isLocked));
    
    tr.style.display = ok ? '' : 'none';
  });
}

['f-date','f-apt','f-staff','f-lock'].forEach(id => {
  document.getElementById(id).addEventListener('change', applyFilter);
});
</script>
</div></body></html>
