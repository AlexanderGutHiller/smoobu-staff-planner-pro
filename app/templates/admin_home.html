
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<title>Admin - Einsätze</title>
<style>
  .filter-input { width: 160px; }
  thead input, thead select { font-size: .875rem; padding: .25rem .5rem; }
  .small-muted { color:#6c757d; font-style: italic; font-size: .9em; }
</style>
</head>
<body class="bg-light"><div class="container py-4">
<h1 class="mb-3">Einsätze</h1>

<div class="d-flex gap-2 mb-3">
  <a class="btn btn-outline-secondary" href="/admin/{{ token }}/staff"><i class="bi bi-people"></i> Team</a>
  <a class="btn btn-outline-secondary" href="/admin/{{ token }}/apartments"><i class="bi bi-building"></i> Apartments</a>
  <a class="btn btn-primary" href="/admin/{{ token }}/import"><i class="bi bi-arrow-repeat"></i> Import jetzt</a>
</div>

<table id="task-table" class="table table-sm table-hover bg-white align-middle">
<thead>
  <tr>
    <th>Datum<br><input id="f-date" type="text" class="form-control form-control-sm filter-input" placeholder="z.B. 2025-10"></th>
    <th>Apartment<br><input id="f-apt" type="text" class="form-control form-control-sm filter-input" placeholder="Name/Gast/Notiz"></th>
    <th>Geplant</th>
    <th>Next Arrival</th>
    <th>MA<br>
      <select id="f-staff" class="form-select form-select-sm filter-input">
        <option value="">Alle</option>
        {% for s in staff %}
          <option value="{{ s.name }}">{{ s.name }}</option>
        {% endfor %}
      </select>
    </th>
    <th>Lock</th>
    <th>#</th>
  </tr>
</thead>
<tbody>
{% for t in tasks %}
<tr class="{% if t.assigned_staff_id %}table-success{% else %}table-warning{% endif %}">
  <td data-col="date">{{ t.date | date_wd_de('short') }}</td>
  <td data-col="apt">
    {{ apt_map.get(t.apartment_id, t.apartment_id) }}<br>
    <small class="small-muted">{{ book_map.get(t.booking_id, '') }}</small>
    {% if t.notes %}<div><small class="text-muted"><i class="bi bi-sticky"></i> {{ t.notes }}</small></div>{% endif %}
  </td>
  <td data-col="planned">{{ t.planned_minutes }} min</td>
  <td data-col="next">
    {% if t.next_arrival %}
      {{ t.next_arrival | date_wd_de('short') }}
      ({{ t.next_arrival_adults or 0 }}+{{ t.next_arrival_children or 0 }})<br>
      <small class="text-muted">{{ t.next_arrival_comments }}</small>
    {% else %}-{% endif %}
  </td>
  <td data-col="staff">
    <form method="post" action="/admin/{{ token }}/task/assign" class="d-flex gap-2">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <select name="staff_id_raw" class="form-select form-select-sm">
        <option value="">–</option>
        {% for s in staff %}
          <option value="{{ s.id }}" {% if t.assigned_staff_id==s.id %}selected{% endif %}>{{ s.name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-sm btn-outline-primary"><i class="bi bi-save"></i></button>
    </form>
  </td>
  <td>
    <form method="post" action="/admin/{{ token }}/task/lock">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <input type="hidden" name="lock" value="{{ 0 if t.locked else 1 }}"/>
      <button class="btn btn-sm {{ 'btn-success' if t.locked else 'btn-outline-secondary' }}">
        {% if t.locked %}<i class="bi bi-lock-fill"></i>{% else %}<i class="bi bi-unlock"></i>{% endif %}
      </button>
    </form>
  </td>
  <td><small>#{{ t.id }}</small></td>
</tr>
{% endfor %}
</tbody></table>
<script>
const rows = Array.from(document.querySelectorAll("#task-table tbody tr"));
function applyFilter(){
  const fDate = document.getElementById('f-date').value.toLowerCase();
  const fApt  = document.getElementById('f-apt').value.toLowerCase();
  const fStaff= document.getElementById('f-staff').value.toLowerCase();
  rows.forEach(tr => {
    const dateTxt = tr.querySelector('[data-col="date"]').innerText.toLowerCase();
    const aptTxt  = tr.querySelector('[data-col="apt"]').innerText.toLowerCase();
    const staffTxt= tr.querySelector('[data-col="staff"]').innerText.toLowerCase();
    const ok = (!fDate || dateTxt.includes(fDate))
            && (!fApt || aptTxt.includes(fApt))
            && (!fStaff || staffTxt.includes(fStaff));
    tr.style.display = ok ? '' : 'none';
  });
}
['f-date','f-apt','f-staff'].forEach(id => {
  document.getElementById(id).addEventListener('input', applyFilter);
  document.getElementById(id).addEventListener('change', applyFilter);
});
</script>
</div></body></html>
