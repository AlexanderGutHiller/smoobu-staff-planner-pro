
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<title>Meine Einsätze</title>
<style>
body { padding-bottom: 20px; }
.task-card {
  border: 2px solid #dee2e6;
  border-radius: 12px;
  transition: all 0.2s;
  overflow: hidden;
}
.task-card:hover {
  border-color: #0d6efd;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.task-card.done {
  opacity: 0.6;
  border-color: #6c757d;
}
.timer-display {
  font-size: 2.5rem;
  font-weight: bold;
  color: #198754;
  text-align: center;
}
.timer-running {
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.progress.over { --bs-progress-bar-bg: #dc3545; }
.guest-info {
  background: #f8f9fa;
  padding: 0.5rem;
  border-radius: 0.375rem;
  font-size: 0.9em;
  margin-top: 0.5rem;
}
.btn-touch {
  min-height: 48px;
  font-size: 1.1rem;
  font-weight: 600;
}
.btn-touch-sm {
  min-height: 44px;
  font-size: 1rem;
}
.status-badge {
  font-size: 1.1rem;
  padding: 0.5rem 1rem;
}
.task-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1rem;
}
@media (max-width: 576px) {
  .timer-display { font-size: 2rem; }
  .container { padding-left: 10px; padding-right: 10px; }
}
</style>
</head>
<body class="bg-light"><div class="container py-3 px-2">
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0" style="font-size: 1.5rem;">Meine Einsätze</h1>
  <select class="form-select form-select-sm" style="width: auto; max-width: 140px;" onchange="setLanguage(this.value)">
    <option value="de" {% if lang == 'de' %}selected{% endif %}>🇩🇪 DE</option>
    <option value="en" {% if lang == 'en' %}selected{% endif %}>🇬🇧 EN</option>
    <option value="fr" {% if lang == 'fr' %}selected{% endif %}>🇫🇷 FR</option>
    <option value="it" {% if lang == 'it' %}selected{% endif %}>🇮🇹 IT</option>
    <option value="es" {% if lang == 'es' %}selected{% endif %}>🇪🇸 ES</option>
    <option value="ro" {% if lang == 'ro' %}selected{% endif %}>🇷🇴 RO</option>
    <option value="ru" {% if lang == 'ru' %}selected{% endif %}>🇷🇺 RU</option>
    <option value="bg" {% if lang == 'bg' %}selected{% endif %}>🇧🇬 BG</option>
  </select>
</div>
<script>
function setLanguage(lang) {
  const currentPath = window.location.pathname + window.location.search;
  window.location.href = `/set-language?lang=${lang}&redirect=${encodeURIComponent(currentPath)}`;
}
</script>
{% if warn_limit %}
  <div class="alert alert-warning alert-dismissible fade show"><i class="bi bi-exclamation-triangle-fill"></i> Du hast dein Monatslimit von {{ staff.max_hours_per_month }} Std überschritten (aktuell {{ used_hours }} Std).</div>
{% else %}
  <div class="alert alert-info alert-dismissible fade show"><i class="bi bi-info-circle"></i> Aktueller Monat: {{ used_hours }} Std erfasst.</div>
{% endif %}

<div class="mb-3">
  {% if show_done %}
    <a class="btn btn-outline-secondary btn-touch-sm" href="/cleaner/{{ staff.magic_token }}"><i class="bi bi-eye-slash"></i> Erledigte ausblenden</a>
  {% else %}
    <a class="btn btn-outline-secondary btn-touch-sm" href="/cleaner/{{ staff.magic_token }}?show_done=1"><i class="bi bi-eye"></i> Erledigte anzeigen</a>
  {% endif %}
</div>

<div class="row g-3">
{% for t in tasks %}
{% set started = run_map.get(t.id) %}
<div class="col-12 task-card {% if t.status=='done' %}done{% endif %}">
  <div class="task-header d-flex justify-content-between align-items-center">
    <div>
      <strong style="font-size: 1.1rem;">{{ t.date | date_wd_de('short') }}</strong>
    </div>
    <div class="fw-bold" style="font-size: 1.5rem;">{{ apt_map.get(t.apartment_id, t.apartment_id) }}</div>
  </div>
  <div class="p-3">
    <div class="row">
      <div class="col-12">
        {% if t.booking_id and book_map.get(t.booking_id) %}
          <div class="mb-2"><i class="bi bi-person-fill"></i> <strong class="text-primary">{{ book_map.get(t.booking_id, '') }}</strong></div>
        {% endif %}
        {% if t.booking_id and booking_details_map.get(t.booking_id) %}
          <div class="mb-2 text-muted">
            <i class="bi bi-people"></i> {{ booking_details_map[t.booking_id].adults }} Erw.
            {% if booking_details_map[t.booking_id].children > 0 %}
              + {{ booking_details_map[t.booking_id].children }} Kinder
            {% endif %}
          </div>
        {% endif %}
        
        {% if t.next_arrival %}
          <div class="guest-info">
            <div class="fw-bold mb-1"><i class="bi bi-calendar3"></i> Nächste Anreise: {{ t.next_arrival | date_wd_de('short') }}</div>
            <div><i class="bi bi-people-fill"></i> <strong>{{ t.next_arrival_adults or 0 }}</strong> Erw.
            {% if t.next_arrival_children and t.next_arrival_children > 0 %}
              + <strong>{{ t.next_arrival_children }}</strong> Kinder
            {% endif %}</div>
            {% if t.next_arrival_guest_name %}
              <div class="mt-1"><i class="bi bi-person-fill"></i> <strong>{{ t.next_arrival_guest_name }}</strong></div>
            {% endif %}
            {% if t.next_arrival_comments %}
              <div class="mt-1 text-muted"><i class="bi bi-chat-text"></i> {{ t.next_arrival_comments[:100] }}</div>
            {% endif %}
          </div>
        {% endif %}
        
        {% if t.notes %}
          <div class="mt-2 text-muted"><i class="bi bi-sticky"></i> {{ t.notes }}</div>
        {% endif %}
      </div>
    </div>
    
    <hr>
    
    <div class="row align-items-center mb-3">
      <div class="col-6 text-center">
        <div class="text-muted small">Geplant</div>
        <div class="fw-bold" style="font-size: 1.3rem;">{{ t.planned_minutes }} min</div>
      </div>
      <div class="col-6 text-center">
        <div class="text-muted small">Status</div>
        {% if t.status=='running' %}
          <span class="badge bg-success status-badge"><i class="bi bi-play-circle-fill"></i> Läuft</span>
        {% elif t.status=='done' %}
          <span class="badge bg-secondary status-badge"><i class="bi bi-check-circle"></i> Erledigt</span>
        {% else %}
          <span class="badge bg-secondary status-badge"><i class="bi bi-hourglass-split"></i> Offen</span>
        {% endif %}
      </div>
    </div>
    
    {% if t.status=='running' %}
      <div class="text-center mb-3">
        <div class="timer-display timer-running">
          <div id="timer-{{ t.id }}" data-started="{{ started or '' }}" data-planned="{{ t.planned_minutes }}">⏱️ 0:00</div>
        </div>
        <div class="small text-muted" id="remaining-{{ t.id }}">verbleibend: --</div>
      </div>
      <div class="progress mb-3" id="prog-{{ t.id }}" style="height:30px;">
        <div class="progress-bar" role="progressbar" style="width: 0%; line-height:30px; font-size: 1rem;" id="pb-{{ t.id }}">0%</div>
      </div>
    {% endif %}
    
    <div class="d-grid gap-2">
      {% if t.status=='open' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/start">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-success btn-touch"><i class="bi bi-play-fill"></i> Start</button>
      </form>
      {% elif t.status=='running' %}
      <div class="row g-2">
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/stop">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-warning btn-touch w-100"><i class="bi bi-pause-fill"></i> Pause</button>
          </form>
        </div>
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/done">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-primary btn-touch w-100"><i class="bi bi-check-circle"></i> Fertig</button>
          </form>
        </div>
      </div>
      {% elif t.status=='done' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/reopen">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-outline-danger btn-touch-sm"><i class="bi bi-arrow-counterclockwise"></i> Wieder öffnen</button>
      </form>
      {% endif %}
      <button class="btn btn-outline-primary btn-touch-sm" data-bs-toggle="modal" data-bs-target="#noteModal" data-task="{{ t.id }}" data-current="{{ t.notes|e }}">
        <i class="bi bi-pencil-square"></i> Notiz
      </button>
    </div>
  </div>
</div>
{% endfor %}
</div>
{% if not tasks %}
  <div class="text-center py-5">
    <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
    <p class="text-muted mt-3">Keine Einsätze vorhanden</p>
  </div>
{% endif %}

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Notiz bearbeiten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="noteTaskId">
        <textarea class="form-control" id="noteText" rows="4" placeholder="Deine Notiz..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" id="saveNoteBtn"><i class="bi bi-floppy"></i> Speichern</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Modal setup
const noteModal = document.getElementById('noteModal');
noteModal.addEventListener('show.bs.modal', event => {
  const button = event.relatedTarget;
  const taskId = button.getAttribute('data-task');
  const current = button.getAttribute('data-current') || '';
  document.getElementById('noteTaskId').value = taskId;
  document.getElementById('noteText').value = current;
});

document.getElementById('saveNoteBtn').addEventListener('click', async () => {
  const taskId = document.getElementById('noteTaskId').value;
  const note = document.getElementById('noteText').value;
  const formData = new FormData();
  formData.append('task_id', taskId);
  formData.append('note', note);
  const resp = await fetch('/cleaner/{{ staff.magic_token }}/note', { method: 'POST', body: formData });
  const data = await resp.json();
  if(data.ok){
    // Update note text in card
    const cards = document.querySelectorAll('.task-card');
    cards.forEach(card => {
      const button = card.querySelector(`button[data-task="${taskId}"]`);
      if (button){
        let noteDiv = card.querySelector('.mt-2.text-muted');
        if(!noteDiv){
          noteDiv = document.createElement('div');
          noteDiv.className = 'mt-2 text-muted';
          const col = card.querySelector('.col-12');
          col.appendChild(noteDiv);
        }
        noteDiv.innerHTML = '<i class="bi bi-sticky"></i> ' + (data.note || '');
      }
    });
    const modal = bootstrap.Modal.getInstance(noteModal);
    modal.hide();
  }
});

// Live timer mit besserer Anzeige
function secondsSince(startIso){
  if(!startIso || startIso === '' || startIso.trim() === '') return 0;
  try {
    const start = new Date(startIso.replace(' ', 'T'));
    const now = new Date();
    const diff = Math.floor((now - start)/1000);
    return Math.max(0, diff); // Ensure non-negative
  } catch(e) {
    return 0;
  }
}

function formatTimeSeconds(totalSeconds){
  if(totalSeconds < 0) totalSeconds = 0;
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  
  if (hours > 0) {
    return `${hours}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  } else {
    return `${minutes}:${String(seconds).padStart(2,'0')}`;
  }
}

function updateTimers(){
  document.querySelectorAll('[id^=timer-]').forEach(el => {
    const id = el.id.split('-')[1];
    const started = el.getAttribute('data-started');
    const planned = parseInt(el.getAttribute('data-planned') || '0', 10);
    
    if(!started){
      el.textContent = '⏱️ 0:00';
      return;
    }
    
    const elapsedSeconds = secondsSince(started);
    const elapsedMinutes = Math.floor(elapsedSeconds / 60);
    const remaining = Math.max(0, planned - elapsedMinutes);
    
    // Timer-Anzeige mit Sekunden
    el.textContent = `⏱️ ${formatTimeSeconds(elapsedSeconds)}`;
    
    // Verbleibende Zeit
    const remainingEl = document.getElementById('remaining-'+id);
    if(remainingEl){
      remainingEl.textContent = elapsedMinutes >= planned ? 
        `⚠️ Über Zeit (+${elapsedMinutes - planned} min)` : 
        `noch ca. ${remaining} min`;
      remainingEl.style.color = elapsedMinutes >= planned ? '#dc3545' : '';
    }
    
    // Progress Bar
    const pb = document.getElementById('pb-'+id);
    if(pb){
      const pct = Math.min(100, Math.round(elapsedMinutes / Math.max(1, planned) * 100));
      pb.style.width = pct + '%';
      pb.textContent = pct + '%';
      
      const prog = document.getElementById('prog-'+id);
      if(prog){
        if(elapsedMinutes >= planned){
          prog.classList.add('over');
          pb.classList.add('bg-danger');
          pb.classList.remove('bg-success');
        } else {
          prog.classList.remove('over');
          pb.classList.add('bg-success');
          pb.classList.remove('bg-danger');
        }
      }
    }
  });
}
updateTimers(); // Sofort beim Laden
setInterval(updateTimers, 1000); // Update jede Sekunde für echtes live-feeling
</script>
</div></body></html>
