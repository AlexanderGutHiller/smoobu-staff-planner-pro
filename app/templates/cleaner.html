
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<title>Meine Einsätze</title>
<style>
.badge-running{background:#198754;}
.badge-done{background:#6c757d;}
tr.row-done{opacity:.6;}
.progress.over{--bs-progress-bar-bg: #dc3545;}
.small-note{color:#6c757d; font-style: italic;}
.timer-display{font-size: 1.2em; font-weight: bold; color: #198754;}
.timer-running{animation: pulse 2s infinite;}
@keyframes pulse{0%, 100%{opacity:1}50%{opacity:0.6}}
.guest-info{background:#f8f9fa; padding:.25rem .5rem; border-radius:.25rem; font-size:.85em;}
</style>
</head>
<body class="bg-light"><div class="container py-4">
<h1 class="mb-3">Meine Einsätze</h1>
{% if warn_limit %}
  <div class="alert alert-warning"><i class="bi bi-exclamation-triangle-fill"></i> Achtung: Du hast dein Monatslimit von {{ staff.max_hours_per_month }} Std überschritten (aktuell {{ used_hours }} Std).</div>
{% else %}
  <div class="alert alert-info">Diesen Link nicht weitergeben. Aktueller Monat: {{ used_hours }} Std erfasst.</div>
{% endif %}

<div class="mb-3">
  {% if show_done %}
    <a class="btn btn-outline-secondary btn-sm" href="/cleaner/{{ staff.magic_token }}"><i class="bi bi-eye-slash"></i> Erledigte ausblenden</a>
  {% else %}
    <a class="btn btn-outline-secondary btn-sm" href="/cleaner/{{ staff.magic_token }}?show_done=1"><i class="bi bi-eye"></i> Erledigte anzeigen</a>
  {% endif %}
</div>

<table class="table table-sm table-hover bg-white align-middle">
<thead><tr><th>Datum</th><th>Apartment & Gast Info</th><th>Geplant</th><th>Status & Timer</th><th>Progress</th><th>Aktion</th></tr></thead>
<tbody>
{% for t in tasks %}
{% set started = run_map.get(t.id) %}
<tr class="{% if t.status=='done' %}row-done{% endif %}">
  <td><strong>{{ t.date | date_wd_de('short') }}</strong></td>
  <td>
    <div class="fw-bold mb-1">{{ apt_map.get(t.apartment_id, t.apartment_id) }}</div>
    {% if t.next_arrival %}
      <div class="guest-info">
        <div><i class="bi bi-people-fill"></i> <strong>{{ t.next_arrival_adults or 0 }}</strong> Erw.
        {% if t.next_arrival_children and t.next_arrival_children > 0 %}
          + <strong>{{ t.next_arrival_children }}</strong> Kinder
        {% endif %}</div>
        {% if t.next_arrival_guest_name %}
          <div><i class="bi bi-person-fill"></i> <strong>{{ t.next_arrival_guest_name }}</strong></div>
        {% endif %}
        <small>{{ t.next_arrival | date_wd_de('short') }}</small>
        {% if t.next_arrival_comments %}
          <br><small class="text-muted"><i class="bi bi-chat-text"></i> {{ t.next_arrival_comments[:80] }}</small>
        {% endif %}
      </div>
    {% elif book_map.get(t.booking_id) %}
      <div class="small text-muted"><i class="bi bi-person"></i> {{ book_map.get(t.booking_id, '') }}</div>
    {% endif %}
    {% if t.notes %}
      <div class="small-note mt-1"><i class="bi bi-sticky"></i> {{ t.notes[:80] }}</div>
    {% endif %}
  </td>
  <td class="text-center">
    <div class="fw-bold">{{ t.planned_minutes }} min</div>
  </td>
  <td>
    {% if t.status=='running' %}
      <div class="timer-display timer-running">
        <div id="timer-{{ t.id }}" data-started="{{ started or '' }}" data-planned="{{ t.planned_minutes }}">⏱️ 0:00</div>
      </div>
      <div class="small text-muted mt-1" id="remaining-{{ t.id }}">verbleibend: --</div>
    {% elif t.status=='done' %}
      <span class="badge badge-done"><i class="bi bi-check-circle"></i> Erledigt</span>
    {% else %}
      <span class="badge bg-secondary"><i class="bi bi-hourglass-split"></i> Offen</span>
    {% endif %}
  </td>
  <td style="min-width:200px;">
    {% if t.status=='running' %}
      <div class="progress" id="prog-{{ t.id }}" style="height:25px;">
        <div class="progress-bar" role="progressbar" style="width: 0%; line-height:25px;" id="pb-{{ t.id }}">0%</div>
      </div>
    {% else %}<div class="text-center text-muted">-</div>{% endif %}
  </td>
  <td>
    <div class="d-flex flex-column gap-1">
      {% if t.status=='open' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/start">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-sm btn-success w-100"><i class="bi bi-play-fill"></i> Start</button>
      </form>
      {% elif t.status=='running' %}
      <div class="btn-group d-flex" role="group">
        <form method="post" action="/cleaner/{{ staff.magic_token }}/stop" class="flex-fill">
          <input type="hidden" name="task_id" value="{{ t.id }}"/>
          <button class="btn btn-sm btn-warning w-100"><i class="bi bi-pause-fill"></i> Pause</button>
        </form>
        <form method="post" action="/cleaner/{{ staff.magic_token }}/done" class="flex-fill">
          <input type="hidden" name="task_id" value="{{ t.id }}"/>
          <button class="btn btn-sm btn-primary w-100"><i class="bi bi-check-circle"></i> Fertig</button>
        </form>
      </div>
      {% elif t.status=='done' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/reopen">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-sm btn-outline-danger w-100"><i class="bi bi-arrow-counterclockwise"></i> Öffnen</button>
      </form>
      {% endif %}
      <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#noteModal" data-task="{{ t.id }}" data-current="{{ t.notes|e }}"><i class="bi bi-pencil-square"></i> Notiz</button>
    </div>
  </td>
</tr>
{% endfor %}
</tbody></table>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Notiz bearbeiten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="noteTaskId">
        <textarea class="form-control" id="noteText" rows="4" placeholder="Deine Notiz..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" id="saveNoteBtn"><i class="bi bi-save"></i> Speichern</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Modal setup
const noteModal = document.getElementById('noteModal');
noteModal.addEventListener('show.bs.modal', event => {
  const button = event.relatedTarget;
  const taskId = button.getAttribute('data-task');
  const current = button.getAttribute('data-current') || '';
  document.getElementById('noteTaskId').value = taskId;
  document.getElementById('noteText').value = current;
});

document.getElementById('saveNoteBtn').addEventListener('click', async () => {
  const taskId = document.getElementById('noteTaskId').value;
  const note = document.getElementById('noteText').value;
  const formData = new FormData();
  formData.append('task_id', taskId);
  formData.append('note', note);
  const resp = await fetch('/cleaner/{{ staff.magic_token }}/note', { method: 'POST', body: formData });
  const data = await resp.json();
  if(data.ok){
    // Update note text inline
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      if (tr.innerHTML.includes('value=\"' + taskId + '\"')){
        let cell = tr.querySelector('td:nth-child(3)'); // apartment cell
        let noteDiv = cell.querySelector('.small-note');
        if(!noteDiv){
          noteDiv = document.createElement('div');
          noteDiv.className = 'small-note';
          cell.appendChild(noteDiv);
        }
        noteDiv.innerHTML = '<i class="bi bi-sticky"></i> ' + (data.note || '');
      }
    });
    const modal = bootstrap.Modal.getInstance(noteModal);
    modal.hide();
  }
});

// Live timer mit besserer Anzeige
function minutesBetween(startIso){
  if(!startIso) return 0;
  const start = new Date(startIso.replace(' ', 'T'));
  const now = new Date();
  return Math.floor((now - start)/60000);
}

function formatTime(minutes){
  const h = Math.floor(minutes / 60);
  const m = minutes % 60;
  return h > 0 ? `${h}:${String(m).padStart(2,'0')}` : `${m} min`;
}

function updateTimers(){
  document.querySelectorAll('[id^=timer-]').forEach(el => {
    const id = el.id.split('-')[1];
    const started = el.getAttribute('data-started');
    const planned = parseInt(el.getAttribute('data-planned') || '0', 10);
    
    if(!started){
      el.textContent = '⏱️ 0:00';
      return;
    }
    
    const elapsed = minutesBetween(started);
    const remaining = Math.max(0, planned - elapsed);
    
    // Timer-Anzeige
    el.textContent = `⏱️ ${formatTime(elapsed)}`;
    
    // Verbleibende Zeit
    const remainingEl = document.getElementById('remaining-'+id);
    if(remainingEl){
      remainingEl.textContent = elapsed >= planned ? 
        `⚠️ Über Zeit (+${elapsed - planned} min)` : 
        `noch ca. ${remaining} min`;
      remainingEl.style.color = elapsed >= planned ? '#dc3545' : '';
    }
    
    // Progress Bar
    const pb = document.getElementById('pb-'+id);
    if(pb){
      const pct = Math.min(100, Math.round(elapsed / Math.max(1, planned) * 100));
      pb.style.width = pct + '%';
      pb.textContent = pct + '%';
      
      const prog = document.getElementById('prog-'+id);
      if(prog){
        if(elapsed >= planned){
          prog.classList.add('over');
          pb.classList.add('bg-danger');
          pb.classList.remove('bg-success');
        } else {
          prog.classList.remove('over');
          pb.classList.add('bg-success');
          pb.classList.remove('bg-danger');
        }
      }
    }
  });
}
updateTimers();
setInterval(updateTimers, 5000); // Update alle 5 Sekunden für live-feeling
</script>
</div></body></html>
