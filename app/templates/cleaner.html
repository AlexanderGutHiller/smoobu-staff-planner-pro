
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<title>Meine Eins√§tze</title>
<style>
.badge-running{background:#198754;}
.badge-done{background:#6c757d;}
tr.row-done{opacity:.6;}
.progress.over{--bs-progress-bar-bg: #dc3545;}
.small-note{color:#6c757d; font-style: italic;}
</style>
</head>
<body class="bg-light"><div class="container py-4">
<h1 class="mb-3">Meine Eins√§tze</h1>
{% if warn_limit %}
  <div class="alert alert-warning"><i class="bi bi-exclamation-triangle-fill"></i> Achtung: Du hast dein Monatslimit von {{ staff.max_hours_per_month }} Std √ºberschritten (aktuell {{ used_hours }} Std).</div>
{% else %}
  <div class="alert alert-info">Diesen Link nicht weitergeben. Aktueller Monat: {{ used_hours }} Std erfasst.</div>
{% endif %}

<div class="mb-3">
  {% if show_done %}
    <a class="btn btn-outline-secondary btn-sm" href="/cleaner/{{ staff.magic_token }}"><i class="bi bi-eye-slash"></i> Erledigte ausblenden</a>
  {% else %}
    <a class="btn btn-outline-secondary btn-sm" href="/cleaner/{{ staff.magic_token }}?show_done=1"><i class="bi bi-eye"></i> Erledigte anzeigen</a>
  {% endif %}
</div>

<table class="table table-sm table-hover bg-white align-middle">
<thead><tr><th>Datum</th><th>Start</th><th>Apartment</th><th>Geplant</th><th>Status</th><th>Fortschritt</th><th>Aktion</th></tr></thead>
<tbody>
{% for t in tasks %}
{% set started = run_map.get(t.id) %}
<tr class="{% if t.status=='done' %}row-done{% endif %}">
  <td>{{ t.date | date_wd_de('short') }}</td>
  <td>{{ t.start_time or '-' }}</td>
  <td>
    {{ apt_map.get(t.apartment_id, t.apartment_id) }}<br>
    <small class="text-muted fst-italic">{{ book_map.get(t.booking_id, '') }}</small>
    {% if t.notes %}<div class="small-note"><i class="bi bi-sticky"></i> {{ t.notes }}</div>{% endif %}
  </td>
  <td>{{ t.planned_minutes }} min</td>
  <td>
    {% if t.status=='running' %}
      <span class="badge badge-running">üü¢ l√§uft</span>
      <div id="runinfo-{{ t.id }}" data-started="{{ started or '' }}" data-planned="{{ t.planned_minutes }}"></div>
    {% elif t.status=='done' %}
      <span class="badge badge-done">‚úÖ erledigt</span>
    {% else %}-{% endif %}
  </td>
  <td style="min-width:180px;">
    {% if t.status=='running' %}
      <div class="progress" id="prog-{{ t.id }}">
        <div class="progress-bar" role="progressbar" style="width: 0%" id="pb-{{ t.id }}">0%</div>
      </div>
    {% else %}-{% endif %}
  </td>
  <td class="d-flex flex-wrap gap-2">
    <form method="post" action="/cleaner/{{ staff.magic_token }}/start">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <button class="btn btn-sm btn-success"><i class="bi bi-play-fill"></i> Start</button>
    </form>
    <form method="post" action="/cleaner/{{ staff.magic_token }}/stop">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <button class="btn btn-sm btn-warning"><i class="bi bi-pause-fill"></i> Stop</button>
    </form>
    <form method="post" action="/cleaner/{{ staff.magic_token }}/done">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <button class="btn btn-sm btn-outline-secondary"><i class="bi bi-check2-square"></i> Erledigt</button>
    </form>
    {% if t.status=='done' %}
    <form method="post" action="/cleaner/{{ staff.magic_token }}/reopen">
      <input type="hidden" name="task_id" value="{{ t.id }}"/>
      <button class="btn btn-sm btn-outline-danger"><i class="bi bi-arrow-counterclockwise"></i> R√ºckg√§ngig</button>
    </form>
    {% endif %}
    <!-- AJAX Note -->
    <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#noteModal" data-task="{{ t.id }}" data-current="{{ t.notes|e }}"><i class="bi bi-pencil-square"></i> Notiz</button>
  </td>
</tr>
{% endfor %}
</tbody></table>

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Notiz bearbeiten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="noteTaskId">
        <textarea class="form-control" id="noteText" rows="4" placeholder="Deine Notiz..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" id="saveNoteBtn"><i class="bi bi-save"></i> Speichern</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Modal setup
const noteModal = document.getElementById('noteModal');
noteModal.addEventListener('show.bs.modal', event => {
  const button = event.relatedTarget;
  const taskId = button.getAttribute('data-task');
  const current = button.getAttribute('data-current') || '';
  document.getElementById('noteTaskId').value = taskId;
  document.getElementById('noteText').value = current;
});

document.getElementById('saveNoteBtn').addEventListener('click', async () => {
  const taskId = document.getElementById('noteTaskId').value;
  const note = document.getElementById('noteText').value;
  const formData = new FormData();
  formData.append('task_id', taskId);
  formData.append('note', note);
  const resp = await fetch('/cleaner/{{ staff.magic_token }}/note', { method: 'POST', body: formData });
  const data = await resp.json();
  if(data.ok){
    // Update note text inline
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      if (tr.innerHTML.includes('value=\"' + taskId + '\"')){
        let cell = tr.querySelector('td:nth-child(3)'); // apartment cell
        let noteDiv = cell.querySelector('.small-note');
        if(!noteDiv){
          noteDiv = document.createElement('div');
          noteDiv.className = 'small-note';
          cell.appendChild(noteDiv);
        }
        noteDiv.innerHTML = '<i class="bi bi-sticky"></i> ' + (data.note || '');
      }
    });
    const modal = bootstrap.Modal.getInstance(noteModal);
    modal.hide();
  }
});

// Live timer + remaining + progress
function minutesBetween(startIso){
  if(!startIso) return 0;
  const start = new Date(startIso.replace(' ', 'T'));
  const now = new Date();
  return Math.floor((now - start)/60000);
}
function updateTimers(){
  document.querySelectorAll('[id^=runinfo-]').forEach(el => {
    const id = el.id.split('-')[1];
    const started = el.getAttribute('data-started');
    const planned = parseInt(el.getAttribute('data-planned') || '0', 10);
    const elapsed = minutesBetween(started);
    const remaining = Math.max(0, planned - elapsed);
    el.textContent = `l√§uft seit ${elapsed} min ‚Äî noch ca. ${remaining} min (von ${planned})`;
    const pb = document.getElementById('pb-'+id);
    if(pb){
      const pct = Math.min(100, Math.round(elapsed / Math.max(1, planned) * 100));
      pb.style.width = pct + '%';
      pb.textContent = pct + '%';
      const prog = document.getElementById('prog-'+id);
      if (elapsed > planned) {
        prog.classList.add('over');
      } else {
        prog.classList.remove('over');
      }
    }
  });
}
updateTimers();
setInterval(updateTimers, 30000);
</script>
</div></body></html>
