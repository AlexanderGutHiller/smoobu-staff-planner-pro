
<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<title>{{ trans.meine_eins√§tze }}</title>
<style>
:root {
  --primary: #0d6efd;
  --success: #198754;
  --warning: #ffc107;
  --info: #0dcaf0;
  --danger: #dc3545;
  --muted: #6c757d;
  --background: #f8f9fa;
  --card-bg: #ffffff;
  --border: #dee2e6;
}

body { background-color: var(--background); }

.task-card {
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 0.75rem; /* kompakter auf iPhone */
  background: var(--card-bg);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  display: block;
  overflow: hidden;
}
.task-card:hover {
  border-color: var(--primary);
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}
.task-card.done {
  border-left: 4px solid var(--success);
  background-color: #e9f7ef; /* sanftes Gr√ºn */
  opacity: 0.95;
}
.task-card.disabled {
  opacity: 0.5;
  pointer-events: none;
  background-color: #f8f9fa;
}
.task-card.paused {
  border-left: 4px solid var(--warning);
  background-color: #fff8e1; /* warmes Gelb */
}
.task-card.running {
  border-left: 4px solid var(--info);
  background-color: #e7f4ff; /* dezentes Blau */
}
.task-card.assign-accepted {
  border-left: 4px solid var(--success);
  background-color: #e9f7ef;
}
.task-card.assign-pending {
  border-left: 4px solid var(--warning);
  background-color: #fff8e1;
}
.task-card.assign-rejected {
  border-left: 4px solid var(--danger);
  background-color: #fdecee;
}

.stats-card {
  background: var(--card-bg);
  border: 1px solid var(--border);
  border-radius: 0.5rem;
  padding: 1rem;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
}

.stats-card:hover {
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  transform: translateY(-2px);
}

.stats-card-value {
  font-size: 1.75rem;
  font-weight: 700;
  color: var(--primary);
  margin: 0.5rem 0;
}

.stats-card-label {
  font-size: 0.875rem;
  color: var(--muted);
}

.cleaner-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: var(--card-bg);
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.cleaner-avatar {
  width: 3rem;
  height: 3rem;
  border-radius: 50%;
  background: rgba(13, 110, 253, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--primary);
  font-size: 1.5rem;
}

.nav-tabs .nav-link {
  border: none;
  color: var(--muted);
  padding: 0.75rem 1rem;
  border-radius: 0.5rem 0.5rem 0 0;
}

.nav-tabs .nav-link.active {
  color: var(--primary);
  background-color: transparent;
  border-bottom: 2px solid var(--primary);
  font-weight: 600;
}
.task-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid #dee2e6;
}
.task-info-row {
  display: flex;
  justify-content: space-between;
  padding: 0.35rem 0;              /* etwas kompakter, damit weniger vertikale Luft */
  border-bottom: 1px solid #f0f0f0;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
.task-info-label {
  font-weight: 600;
  color: #6c757d;
  min-width: 100px;
  flex-shrink: 0;
}
.task-info-row > span:last-child {
  flex: 1;
  text-align: right;
  word-wrap: break-word;
  overflow-wrap: break-word;
}
.row.g-3 > .col-12 {
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  flex: 0 0 100%;
  padding-left: 0; /* gleiche Breite ohne Gutter */
  padding-right: 0;
}
/* Erzwinge korrektes Umbrechen langer Inhalte, damit Karten nicht breiter werden */
.task-card, .task-card * {
  word-wrap: break-word;
  overflow-wrap: anywhere;
  max-width: 100% !important;
  box-sizing: border-box !important;
}
.row.g-3 { 
  --bs-gutter-x: 0; 
  margin-left: 0 !important; 
  margin-right: 0 !important; 
  row-gap: 0.75rem !important; /* einheitlicher vertikaler Abstand */
}
.row.g-3 > .col-4,
.row.g-3 > .col-12 { 
  margin-left: 0 !important; 
  margin-right: 0 !important; 
  padding-top: 0 !important; 
  padding-bottom: 0 !important;
  margin-top: 0 !important;
  margin-bottom: 0 !important;
}
.task-card { 
  width: 100% !important; 
  margin: 0 !important;          /* keine zus√§tzlichen Au√üenabst√§nde */
  margin-bottom: 0 !important;    /* kein margin-bottom auf Mobile */
  padding: 0.85rem 1rem;         /* leicht reduziertes Padding f√ºr kompaktere Karten */
  border-radius: 0.75rem;
}
.container > .row.g-3 { width: 100% !important; }
.row.g-3 > .col-12 { width: 100% !important; max-width: 100% !important; padding-left: 0 !important; padding-right: 0 !important; display: block; }
.task-card { max-width: 100% !important; overflow-x: hidden; }
.container { overflow-x: hidden; }
.container { max-width: 100% !important; }
.badge { white-space: normal; }
.task-card-header > div { min-width: 0; }
.task-card-header .fw-bold { word-break: break-word; }
.task-card img { max-width: 100%; height: auto; }
.timer-display {
  font-size: 2.5rem;
  font-weight: bold;
  color: #198754;
  text-align: center;
}
.timer-running {
  animation: pulse 2s infinite;
}
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.btn-touch {
  min-height: 48px;
  font-size: 1.1rem;
  font-weight: 600;
}
.btn-touch-sm {
  min-height: 44px;
  font-size: 1rem;
}
.status-badge {
  font-size: 1.1rem;
  padding: 0.5rem 1rem;
}
@media (max-width: 768px) {
  .container { padding-left: 10px; padding-right: 10px; }
  .btn { padding: 0.5rem 0.75rem; font-size: 0.875rem; }
  .timer-display { font-size: 2rem; }
  /* Stats-Spalten auf 100% umbruchen, um Mischbreiten zu vermeiden */
  .row.g-3 .col-4 { flex: 0 0 100% !important; max-width: 100% !important; }
  /* Form-Controls f√ºllen Breite und verursachen kein √úberlaufen */
  select.form-select, input.form-control, textarea.form-control { max-width: 100%; width: 100%; }
  /* Mobile: Keine zus√§tzlichen Abst√§nde zwischen Karten */
  .row.g-3 {
    row-gap: 0.75rem !important;
    margin-bottom: 0 !important;
  }
  .row.g-3 > .col-12 {
    margin-bottom: 0 !important;
    padding-bottom: 0 !important;
  }
  .task-card {
    margin-bottom: 0 !important;
  }
  /* Sicherstellen, dass keine leeren Bereiche zwischen Karten entstehen */
  .tab-pane .row.g-3 {
    margin-top: 0 !important;
    padding-top: 0 !important;
  }
}
</style>
</head>
<body class="bg-light"><div class="container py-4">
<div class="d-flex justify-content-end mb-2">
  <small class="text-muted" style="font-size:0.75rem;">{{ APP_VERSION_DISPLAY }}</small>
</div>
{% if has_running %}
<style>
/* Harte Absicherung: wenn ein Task l√§uft, alle anderen Karten deaktivieren (Desktop) */
@media (min-width: 769px) {
  .task-card:not(.running) { pointer-events: none; opacity: 0.5; }
}

/* Mobile: Nur die laufende Aufgabe anzeigen, aber Scrollen erlauben,
   damit alle Buttons (Stop/Fertig/Notiz) erreichbar bleiben */
@media (max-width: 768px) {
  .task-card:not(.running) {
    display: none !important;
  }
}
</style>
{% endif %}
<!-- Header mit Avatar -->
<div class="cleaner-header">
  <div class="cleaner-avatar">
    <i class="bi bi-person-fill"></i>
  </div>
  <div class="flex-1">
    <h1 class="mb-0" style="font-size: 1.5rem; font-weight: 700;">{{ trans.meine_eins√§tze }}</h1>
    <p class="mb-0 text-muted" style="font-size: 0.875rem;">{{ staff.name }}</p>
  </div>
  <div class="d-flex gap-2 align-items-center">
    <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#newTaskModal"><i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">{{ trans.neue_aufgabe }}</span></button>
    <button id="btnEnablePushCleaner" class="btn btn-outline-success btn-sm" type="button"><i class="bi bi-bell"></i></button>
    {% if staff.is_admin %}
    <a class="btn btn-outline-primary btn-sm" href="/admin/{{ staff.magic_token }}"><i class="bi bi-arrow-left-right"></i></a>
    {% endif %}
    <select class="form-select form-select-sm" style="width: auto;" onchange="setLanguage(this.value)">
    <option value="de" {% if lang == 'de' %}selected{% endif %}>üá©üá™ Deutsch</option>
    <option value="en" {% if lang == 'en' %}selected{% endif %}>üá¨üáß English</option>
    <option value="fr" {% if lang == 'fr' %}selected{% endif %}>üá´üá∑ Fran√ßais</option>
    <option value="it" {% if lang == 'it' %}selected{% endif %}>üáÆüáπ Italiano</option>
    <option value="es" {% if lang == 'es' %}selected{% endif %}>üá™üá∏ Espa√±ol</option>
    <option value="ro" {% if lang == 'ro' %}selected{% endif %}>üá∑üá¥ Rom√¢nƒÉ</option>
    <option value="ru" {% if lang == 'ru' %}selected{% endif %}>üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
    <option value="bg" {% if lang == 'bg' %}selected{% endif %}>üáßüá¨ –ë—ä–ª–≥–∞—Ä—Å–∫–∏</option>
    </select>
  </div>
</div>
{% if staff.is_admin %}
<div class="mb-3">
  <a class="btn btn-outline-primary btn-sm" href="/admin/{{ staff.magic_token }}"><i class="bi bi-arrow-left-right"></i> Zur Admin-Ansicht</a>
</div>
{% endif %}
<script>
function setLanguage(lang) {
  const currentPath = window.location.pathname + window.location.search;
  window.location.href = `/set-language?lang=${lang}&redirect=${encodeURIComponent(currentPath)}`;
}
</script>
{% if warn_limit %}
  <div class="alert alert-warning alert-dismissible fade show"><i class="bi bi-exclamation-triangle-fill"></i> {{ trans.monatslimit }} {{ staff.max_hours_per_month }} {{ trans.std_√ºberschritten }} ({{ trans.aktuell }} {{ used_hours }} {{ trans.std_√ºberschritten }})</div>
{% else %}
  <div class="alert alert-info alert-dismissible fade show"><i class="bi bi-info-circle"></i> {{ trans.monat_erfasst }} {{ used_hours }} {{ trans.std_√ºberschritten }}</div>
{% endif %}

<!-- Stats Cards -->
<div class="row g-3 mb-4">
  <div class="col-4">
    <div class="stats-card">
      <i class="bi bi-calendar-check text-primary" style="font-size: 1.5rem;"></i>
      <div class="stats-card-value">{% set today_str = dt.date.today().isoformat() %}{% set today_count = tasks|selectattr('date', 'equalto', today_str)|list|length %}{{ today_count }}</div>
      <div class="stats-card-label">Heute</div>
    </div>
  </div>
  <div class="col-4">
    <div class="stats-card">
      <i class="bi bi-check-circle text-success" style="font-size: 1.5rem;"></i>
      <div class="stats-card-value">{{ tasks|selectattr('status', 'equalto', 'done')|list|length }}</div>
      <div class="stats-card-label">Erledigt</div>
    </div>
  </div>
  <div class="col-4">
    <div class="stats-card">
      <i class="bi bi-clock text-info" style="font-size: 1.5rem;"></i>
      <div class="stats-card-value">{{ tasks|sum(attribute='planned_minutes') | minutes_to_hhmm }}</div>
      <div class="stats-card-label">Zeit</div>
    </div>
  </div>
</div>

<!-- Monats√ºbersicht -->
<div class="d-flex gap-2 flex-wrap mb-3">
  <span class="badge bg-secondary">{{ trans.vorletzter_monat }}: {{ hours_prev_last }} {{ trans.stunden }}</span>
  <span class="badge bg-secondary">{{ trans.letzter_monat }}: {{ hours_last }} {{ trans.stunden }}</span>
  <span class="badge bg-primary">{{ trans.aktueller_monat }}: {{ hours_current }} {{ trans.stunden }}</span>
</div>

<!-- Tabs f√ºr Filterung -->
<ul class="nav nav-tabs mb-3" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-all" data-bs-toggle="tab" data-bs-target="#content-all" type="button" role="tab">
      Alle ({{ tasks|length }})
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-open" data-bs-toggle="tab" data-bs-target="#content-open" type="button" role="tab">
      Offen ({{ tasks|selectattr('status', 'ne', 'done')|list|length }})
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-done" data-bs-toggle="tab" data-bs-target="#content-done" type="button" role="tab">
      Erledigt ({{ tasks|selectattr('status', 'equalto', 'done')|list|length }})
    </button>
  </li>
</ul>

<!-- Tab Content -->
<div class="tab-content">
  <!-- Alle Tasks -->
  <div class="tab-pane fade show active" id="content-all" role="tabpanel">
    <div class="row g-3">
{% set running_task_id = none %}
{% for t in tasks %}
  {% if t.status == 'running' %}
    {% set running_task_id = t.id %}
  {% endif %}
{% endfor %}
{% for t in tasks %}
{% set started = run_map.get(t.id) %}
{% set is_disabled = running_task_id and running_task_id != t.id and t.status != 'running' and t.status != 'done' %}
{% set tl = timelog_map.get(t.id, {}) if timelog_map else {} %}
{% set extras = extras_map.get(t.id, {}) if extras_map else {} %}
{% set baby_beds = extras.get('baby_beds', 0) %}
<div id="task-{{ t.id }}" class="col-12 task-card {% if t.status=='done' %}done{% elif is_disabled %}disabled{% elif t.status=='paused' %}paused{% endif %} {% if t.status=='running' %}running{% endif %} {% if t.assignment_status=='accepted' %}assign-accepted{% elif t.assignment_status=='pending' %}assign-pending{% elif t.assignment_status=='rejected' %}assign-rejected{% endif %}">
  <div class="task-card-header">
    <div>
      <strong style="font-size: 1.1rem;">{{ t.date | date_wd_de('short') }}</strong>
      <div class="fw-bold text-primary" style="font-size: 1.2rem;">{% if t.apartment_id %}{{ apt_map.get(t.apartment_id, t.apartment_id) }}{% else %}{{ trans.manuelle_aufgabe }}{% endif %}</div>
    </div>
    <div>
      {% if t.status=='running' %}
        <span class="badge bg-success"><i class="bi bi-play-circle"></i> {{ trans.l√§uft }}</span>
      {% elif t.status=='paused' %}
        <span class="badge bg-info"><i class="bi bi-pause-circle"></i> {{ trans.pausiert }}</span>
      {% elif t.status=='done' %}
        <span class="badge bg-secondary"><i class="bi bi-check-circle"></i> {{ trans.erledigt }}</span>
      {% else %}
        <span class="badge bg-secondary"><i class="bi bi-hourglass-split"></i> {{ trans.offen }}</span>
      {% endif %}
    </div>
  </div>
  
  <div class="task-info-row">
    <span class="task-info-label">{{ trans.planned }}:</span>
    <span class="fw-bold">{{ t.planned_minutes | minutes_to_hhmm }}</span>
  </div>

  <div class="task-info-row">
    <span class="task-info-label">{{ trans.babybetten }}:</span>
    <span>{{ baby_beds }}</span>
  </div>
  
  <div class="task-info-row">
    <span class="task-info-label">{{ trans.actual }}:</span>
    <span>
      {% if tl.get('actual_minutes') %}
        <span class="fw-bold {% if tl.actual_minutes > t.planned_minutes %}text-danger{% elif tl.actual_minutes > t.planned_minutes * 0.8 %}text-warning{% else %}text-success{% endif %}">
          {{ tl.actual_minutes | minutes_to_hhmm }}
        </span>
        {% if tl.actual_minutes > t.planned_minutes %}
          <small class="text-danger d-block">+{{ (tl.actual_minutes - t.planned_minutes) | minutes_to_hhmm }}</small>
        {% endif %}
      {% else %}
        <span class="text-muted">-</span>
      {% endif %}
    </span>
  </div>
  
  {% if t.booking_id %}
    {% set guest_name = book_map.get(t.booking_id) or booking_details_map.get(t.booking_id, {}).get('guest_name', '') %}
    {% if guest_name and guest_name.strip() %}
      <div class="task-info-row">
        <span class="task-info-label"><i class="bi bi-person"></i> Gast:</span>
        <span class="text-primary fw-bold">{{ guest_name }}</span>
      </div>
    {% endif %}
    {% if booking_details_map.get(t.booking_id) %}
      <div class="task-info-row">
        <span class="task-info-label"><i class="bi bi-people"></i> G√§ste:</span>
        <span>
          {{ booking_details_map[t.booking_id].adults }} {{ trans.erw }}
          {% if booking_details_map[t.booking_id].children > 0 %}
            + {{ booking_details_map[t.booking_id].children }} {{ trans.kinder }}
          {% endif %}
        </span>
      </div>
    {% endif %}
  {% endif %}
  
  {% if t.next_arrival %}
  <div class="task-info-row">
    <span class="task-info-label">{{ trans.next_arrival }}:</span>
    <span>
      <div class="fw-bold">{{ t.next_arrival | date_wd_de('short') }}</div>
      <div class="small">
        <i class="bi bi-people"></i> {{ t.next_arrival_adults or 0 }} {{ trans.erw }}
        {% if t.next_arrival_children and t.next_arrival_children > 0 %}
          + {{ t.next_arrival_children }} {{ trans.kinder }}
        {% endif %}
      </div>
      {% if t.next_arrival_guest_name %}
        <div class="small text-primary"><i class="bi bi-person"></i> {{ t.next_arrival_guest_name }}</div>
      {% endif %}
      {% if t.next_arrival_comments %}
        <div class="small text-muted"><i class="bi bi-chat-text"></i> {{ t.next_arrival_comments[:100] }}</div>
      {% endif %}
    </span>
  </div>
  {% endif %}
  
  {% if t.notes %}
  <div class="task-info-row" style="background:#fff7e6;border-radius:0.4rem;border:1px solid #ffe0b3;margin-top:0.4rem;">
    <span class="task-info-label" style="color:#b26a00;"><i class="bi bi-sticky"></i> {{ trans.beschreibung if trans.beschreibung is defined else trans.notiz }}:</span>
    <span class="fw-semibold" style="color:#b26a00;">{{ t.notes }}</span>
  </div>
  {% endif %}
    
    {% if t.status=='running' %}
      <div class="text-center mb-3">
        <div class="timer-display timer-running">
          <div id="timer-{{ t.id }}" data-started="{{ started or '' }}" data-planned="{{ t.planned_minutes }}" data-accumulated="{{ (timelog_map.get(t.id, {}).get('actual_minutes', 0) if timelog_map else 0) or 0 }}">‚è±Ô∏è 0:00</div>
        </div>
        <div class="small text-muted" id="remaining-{{ t.id }}" data-lang-over="{{ trans.√ºber_zeit }}" data-lang-min="{{ trans.min }}" data-lang-remaining="{{ trans.noch }}">{{ trans.verbleibend }} --</div>
      </div>
    {% elif t.status=='paused' and tl.get('actual_minutes') %}
      <div class="text-center mb-3">
        <div class="timer-display" style="color: #0dcaf0;">
          <div><i class="bi bi-pause-circle-fill"></i> {{ tl.actual_minutes | minutes_to_hhmm }}</div>
        </div>
        <div class="small text-muted">{{ trans.pausiert }}</div>
      </div>
    {% endif %}
    
    <div class="d-grid gap-2">
      {% if t.assignment_status == 'pending' %}
      <div class="alert alert-warning mb-2">
        <i class="bi bi-hourglass-split"></i> <strong>{{ trans.zuweisung }} {{ trans.pending }}</strong>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/accept">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-success btn-touch w-100"><i class="bi bi-check-circle"></i> {{ trans.annehmen }}</button>
          </form>
        </div>
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/reject">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-danger btn-touch w-100"><i class="bi bi-x-circle"></i> {{ trans.ablehnen }}</button>
          </form>
        </div>
      </div>
      {% elif t.status=='open' and t.assignment_status != 'pending' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/start">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-success btn-touch" {% if is_disabled %}disabled{% endif %}><i class="bi bi-play-fill"></i> {{ trans.start }}</button>
      </form>
      {% elif t.status=='paused' and t.assignment_status != 'pending' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/start">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-success btn-touch" {% if is_disabled %}disabled{% endif %}><i class="bi bi-play-fill"></i> {{ trans.start }}</button>
      </form>
      {% elif t.status=='running' %}
      <div class="row g-2">
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/stop">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-warning btn-touch w-100"><i class="bi bi-pause-fill"></i> {{ trans.pause }}</button>
          </form>
        </div>
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/done">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-primary btn-touch w-100"><i class="bi bi-check-circle"></i> {{ trans.fertig }}</button>
          </form>
        </div>
      </div>
      {% elif t.status=='done' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/reopen">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-outline-danger btn-touch-sm"><i class="bi bi-arrow-counterclockwise"></i> {{ trans.wieder_√∂ffnen }}</button>
      </form>
      {% endif %}
      {% if not t.auto_generated %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/task/delete" onsubmit="return confirm('Diesen Task l√∂schen?');" class="mt-2">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-outline-danger btn-touch-sm"><i class="bi bi-trash"></i> L√∂schen</button>
      </form>
      {% endif %}
      <button class="btn btn-outline-primary btn-touch-sm" data-bs-toggle="modal" data-bs-target="#noteModal" data-task="{{ t.id }}" data-current="{{ t.notes|e }}">
        <i class="bi bi-pencil-square"></i> {{ trans.notiz }}
      </button>
    </div>
  </div>
</div>
{% endfor %}
    </div>
    {% if not tasks %}
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
        <p class="text-muted mt-3">Keine Eins√§tze vorhanden</p>
      </div>
    {% endif %}
  </div>
  
  <!-- Offene Tasks -->
  <div class="tab-pane fade" id="content-open" role="tabpanel">
    <div class="row g-3">
{% set running_task_id = none %}
{% for t in tasks %}
  {% if t.status == 'running' %}
    {% set running_task_id = t.id %}
  {% endif %}
{% endfor %}
{% for t in tasks %}
  {% if t.status != 'done' %}
{% set started = run_map.get(t.id) %}
{% set is_disabled = running_task_id and running_task_id != t.id and t.status != 'running' and t.status != 'done' %}
{% set tl = timelog_map.get(t.id, {}) if timelog_map else {} %}
{% set extras = extras_map.get(t.id, {}) if extras_map else {} %}
{% set baby_beds = extras.get('baby_beds', 0) %}
<div id="task-{{ t.id }}" class="col-12 task-card {% if t.status=='done' %}done{% elif is_disabled %}disabled{% elif t.status=='paused' %}paused{% endif %} {% if t.status=='running' %}running{% endif %} {% if t.assignment_status=='accepted' %}assign-accepted{% elif t.assignment_status=='pending' %}assign-pending{% elif t.assignment_status=='rejected' %}assign-rejected{% endif %}">
  <div class="task-card-header">
    <div>
      <strong style="font-size: 1.1rem;">{{ t.date | date_wd_de('short') }}</strong>
      <div class="fw-bold text-primary" style="font-size: 1.2rem;">{% if t.apartment_id %}{{ apt_map.get(t.apartment_id, t.apartment_id) }}{% else %}{{ trans.manuelle_aufgabe }}{% endif %}</div>
    </div>
    <div>
      {% if t.status=='running' %}
        <span class="badge bg-success"><i class="bi bi-play-circle"></i> {{ trans.l√§uft }}</span>
      {% elif t.status=='paused' %}
        <span class="badge bg-info"><i class="bi bi-pause-circle"></i> {{ trans.pausiert }}</span>
      {% else %}
        <span class="badge bg-secondary"><i class="bi bi-hourglass-split"></i> {{ trans.offen }}</span>
      {% endif %}
    </div>
  </div>
  
  <div class="task-info-row">
    <span class="task-info-label">{{ trans.planned }}:</span>
    <span class="fw-bold">{{ t.planned_minutes | minutes_to_hhmm }}</span>
  </div>

  <div class="task-info-row">
    <span class="task-info-label">{{ trans.babybetten }}:</span>
    <span>{{ baby_beds }}</span>
  </div>
  
  <div class="task-info-row">
    <span class="task-info-label">{{ trans.actual }}:</span>
    <span>
      {% if tl.get('actual_minutes') %}
        <span class="fw-bold {% if tl.actual_minutes > t.planned_minutes %}text-danger{% elif tl.actual_minutes > t.planned_minutes * 0.8 %}text-warning{% else %}text-success{% endif %}">
          {{ tl.actual_minutes | minutes_to_hhmm }}
        </span>
        {% if tl.actual_minutes > t.planned_minutes %}
          <small class="text-danger d-block">+{{ (tl.actual_minutes - t.planned_minutes) | minutes_to_hhmm }}</small>
        {% endif %}
      {% else %}
        <span class="text-muted">-</span>
      {% endif %}
    </span>
  </div>
  
  {% if t.booking_id %}
    {% set guest_name = book_map.get(t.booking_id) or booking_details_map.get(t.booking_id, {}).get('guest_name', '') %}
    {% if guest_name and guest_name.strip() %}
      <div class="task-info-row">
        <span class="task-info-label"><i class="bi bi-person"></i> Gast:</span>
        <span class="text-primary fw-bold">{{ guest_name }}</span>
      </div>
    {% endif %}
  {% endif %}
  
  {% if t.notes %}
  <div class="task-info-row">
    <span class="task-info-label"><i class="bi bi-sticky"></i> {{ trans.notiz }}:</span>
    <span class="text-muted">{{ t.notes }}</span>
  </div>
  {% endif %}
    
    {% if t.status=='running' %}
      <div class="text-center mb-3">
        <div class="timer-display timer-running">
          <div id="timer-{{ t.id }}" data-started="{{ started or '' }}" data-planned="{{ t.planned_minutes }}" data-accumulated="{{ (timelog_map.get(t.id, {}).get('actual_minutes', 0) if timelog_map else 0) or 0 }}">‚è±Ô∏è 0:00</div>
        </div>
        <div class="small text-muted" id="remaining-{{ t.id }}" data-lang-over="{{ trans.√ºber_zeit }}" data-lang-min="{{ trans.min }}" data-lang-remaining="{{ trans.noch }}">{{ trans.verbleibend }} --</div>
      </div>
    {% elif t.status=='paused' and tl.get('actual_minutes') %}
      <div class="text-center mb-3">
        <div class="timer-display" style="color: #0dcaf0;">
          <div><i class="bi bi-pause-circle-fill"></i> {{ tl.actual_minutes | minutes_to_hhmm }}</div>
        </div>
        <div class="small text-muted">{{ trans.pausiert }}</div>
      </div>
    {% endif %}
    
    <div class="d-grid gap-2">
      {% if t.assignment_status == 'pending' %}
      <div class="alert alert-warning mb-2">
        <i class="bi bi-hourglass-split"></i> <strong>{{ trans.zuweisung }} {{ trans.pending }}</strong>
      </div>
      <div class="row g-2 mb-2">
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/accept">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-success btn-touch w-100"><i class="bi bi-check-circle"></i> {{ trans.annehmen }}</button>
          </form>
        </div>
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/reject">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-danger btn-touch w-100"><i class="bi bi-x-circle"></i> {{ trans.ablehnen }}</button>
          </form>
        </div>
      </div>
      {% elif t.status=='open' and t.assignment_status != 'pending' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/start">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-success btn-touch" {% if is_disabled %}disabled{% endif %}><i class="bi bi-play-fill"></i> {{ trans.start }}</button>
      </form>
      {% elif t.status=='paused' and t.assignment_status != 'pending' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/start">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-success btn-touch" {% if is_disabled %}disabled{% endif %}><i class="bi bi-play-fill"></i> {{ trans.start }}</button>
      </form>
      {% elif t.status=='running' %}
      <div class="row g-2">
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/stop">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-warning btn-touch w-100"><i class="bi bi-pause-fill"></i> {{ trans.pause }}</button>
          </form>
        </div>
        <div class="col-6">
          <form method="post" action="/cleaner/{{ staff.magic_token }}/done">
            <input type="hidden" name="task_id" value="{{ t.id }}"/>
            <button class="btn btn-primary btn-touch w-100"><i class="bi bi-check-circle"></i> {{ trans.fertig }}</button>
          </form>
        </div>
      </div>
      {% endif %}
      {% if not t.auto_generated %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/task/delete" onsubmit="return confirm('Diesen Task l√∂schen?');" class="mt-2">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-outline-danger btn-touch-sm"><i class="bi bi-trash"></i> L√∂schen</button>
      </form>
      {% endif %}
      <button class="btn btn-outline-primary btn-touch-sm" data-bs-toggle="modal" data-bs-target="#noteModal" data-task="{{ t.id }}" data-current="{{ t.notes|e }}">
        <i class="bi bi-pencil-square"></i> {{ trans.notiz }}
      </button>
    </div>
  </div>
</div>
  {% endif %}
{% endfor %}
    </div>
    {% set open_tasks = tasks|selectattr('status', 'ne', 'done')|list %}
    {% if not open_tasks %}
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
        <p class="text-muted mt-3">Keine offenen Eins√§tze</p>
      </div>
    {% endif %}
  </div>
  
  <!-- Erledigte Tasks -->
  <div class="tab-pane fade" id="content-done" role="tabpanel">
    <div class="row g-3">
{% set running_task_id = none %}
{% for t in tasks %}
  {% if t.status == 'running' %}
    {% set running_task_id = t.id %}
  {% endif %}
{% endfor %}
{% for t in tasks %}
  {% if t.status == 'done' %}
{% set started = run_map.get(t.id) %}
{% set is_disabled = running_task_id and running_task_id != t.id and t.status != 'running' and t.status != 'done' %}
{% set tl = timelog_map.get(t.id, {}) if timelog_map else {} %}
{% set extras = extras_map.get(t.id, {}) if extras_map else {} %}
{% set baby_beds = extras.get('baby_beds', 0) %}
<div id="task-{{ t.id }}" class="col-12 task-card {% if t.status=='done' %}done{% elif is_disabled %}disabled{% elif t.status=='paused' %}paused{% endif %} {% if t.status=='running' %}running{% endif %} {% if t.assignment_status=='accepted' %}assign-accepted{% elif t.assignment_status=='pending' %}assign-pending{% elif t.assignment_status=='rejected' %}assign-rejected{% endif %}">
  <div class="task-card-header">
    <div>
      <strong style="font-size: 1.1rem;">{{ t.date | date_wd_de('short') }}</strong>
      <div class="fw-bold text-primary" style="font-size: 1.2rem;">{% if t.apartment_id %}{{ apt_map.get(t.apartment_id, t.apartment_id) }}{% else %}{{ trans.manuelle_aufgabe }}{% endif %}</div>
    </div>
    <div>
      <span class="badge bg-secondary"><i class="bi bi-check-circle"></i> {{ trans.erledigt }}</span>
    </div>
  </div>
  
  <div class="task-info-row">
    <span class="task-info-label">{{ trans.planned }}:</span>
    <span class="fw-bold">{{ t.planned_minutes | minutes_to_hhmm }}</span>
  </div>

  <div class="task-info-row">
    <span class="task-info-label">{{ trans.babybetten }}:</span>
    <span>{{ baby_beds }}</span>
  </div>
  
  <div class="task-info-row">
    <span class="task-info-label">{{ trans.actual }}:</span>
    <span>
      {% if tl.get('actual_minutes') %}
        <span class="fw-bold {% if tl.actual_minutes > t.planned_minutes %}text-danger{% elif tl.actual_minutes > t.planned_minutes * 0.8 %}text-warning{% else %}text-success{% endif %}">
          {{ tl.actual_minutes | minutes_to_hhmm }}
        </span>
        {% if tl.actual_minutes > t.planned_minutes %}
          <small class="text-danger d-block">+{{ (tl.actual_minutes - t.planned_minutes) | minutes_to_hhmm }}</small>
        {% endif %}
      {% else %}
        <span class="text-muted">-</span>
      {% endif %}
    </span>
  </div>
  
  {% if t.booking_id %}
    {% set guest_name = book_map.get(t.booking_id) or booking_details_map.get(t.booking_id, {}).get('guest_name', '') %}
    {% if guest_name and guest_name.strip() %}
      <div class="task-info-row">
        <span class="task-info-label"><i class="bi bi-person"></i> Gast:</span>
        <span class="text-primary fw-bold">{{ guest_name }}</span>
      </div>
    {% endif %}
  {% endif %}
  
  {% if t.notes %}
  <div class="task-info-row">
    <span class="task-info-label"><i class="bi bi-sticky"></i> {{ trans.notiz }}:</span>
    <span class="text-muted">{{ t.notes }}</span>
  </div>
  {% endif %}
    
    <div class="d-grid gap-2">
      {% if t.status=='done' %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/reopen">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-outline-danger btn-touch-sm"><i class="bi bi-arrow-counterclockwise"></i> {{ trans.wieder_√∂ffnen }}</button>
      </form>
      {% endif %}
      {% if not t.auto_generated %}
      <form method="post" action="/cleaner/{{ staff.magic_token }}/task/delete" onsubmit="return confirm('Diesen Task l√∂schen?');" class="mt-2">
        <input type="hidden" name="task_id" value="{{ t.id }}"/>
        <button class="btn btn-outline-danger btn-touch-sm"><i class="bi bi-trash"></i> L√∂schen</button>
      </form>
      {% endif %}
      <button class="btn btn-outline-primary btn-touch-sm" data-bs-toggle="modal" data-bs-target="#noteModal" data-task="{{ t.id }}" data-current="{{ t.notes|e }}">
        <i class="bi bi-pencil-square"></i> {{ trans.notiz }}
      </button>
    </div>
  </div>
</div>
  {% endif %}
{% endfor %}
    </div>
    {% set done_tasks = tasks|selectattr('status', 'equalto', 'done')|list %}
    {% if not done_tasks %}
      <div class="text-center py-5">
        <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
        <p class="text-muted mt-3">Keine erledigten Eins√§tze</p>
      </div>
    {% endif %}
  </div>
</div>
<!-- End tab content -->

<!-- Note Modal -->
<div class="modal fade" id="noteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Notiz bearbeiten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="noteTaskId">
        <textarea class="form-control" id="noteText" rows="4" placeholder="Deine Notiz..."></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button type="button" class="btn btn-primary" id="saveNoteBtn"><i class="bi bi-floppy"></i> Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Neue Aufgabe (Cleaner) -->
<div class="modal fade" id="newTaskModal" tabindex="-1" aria-labelledby="newTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newTaskModalLabel">{{ trans.neue_aufgabe }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="/cleaner/{{ staff.magic_token }}/task/create" id="newCleanerTaskForm">
        <div class="modal-body">
          <div class="mb-3">
            <label for="c-task-date" class="form-label">{{ trans.date }} *</label>
            <input type="date" class="form-control" id="c-task-date" name="date" required>
          </div>
          <div class="mb-3">
            <label for="c-task-duration" class="form-label">{{ trans.dauer }} *</label>
            <input type="number" class="form-control" id="c-task-duration" name="planned_minutes" min="1" value="90" required>
          </div>
          <div class="mb-3">
            <label for="c-task-description" class="form-label">{{ trans.beschreibung }}</label>
            <textarea class="form-control" id="c-task-description" name="description" rows="3" placeholder="{{ trans.t√§tigkeit }}"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ trans.abbrechen }}</button>
          <button type="submit" class="btn btn-primary">{{ trans.erstellen }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Scroll-Position und Fokus beim Cleaner erhalten (Start/Pause/Fertig/Annehmen/Ablehnen)
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    try {
      const anchorId = sessionStorage.getItem('cleanerAnchor');
      const scrollY = sessionStorage.getItem('cleanerScrollY');
      if (anchorId) {
        const el = document.getElementById(anchorId);
        if (el) {
          el.scrollIntoView({ behavior: 'instant', block: 'center' });
        }
      } else if (scrollY) {
        window.scrollTo(0, parseInt(scrollY, 10) || 0);
      }
    } catch (e) {}
    // Aufr√§umen
    try {
      sessionStorage.removeItem('cleanerAnchor');
      sessionStorage.removeItem('cleanerScrollY');
    } catch (e) {}
  });

  // Vor Submit aller relevanten Cleaner-Formulare die Position merken
  function attachCleanerPreserveHandlers() {
    const sel = [
      'form[action$="/accept"]',
      'form[action$="/reject"]',
      'form[action$="/start"]',
      'form[action$="/stop"]',
      'form[action$="/done"]',
      'form[action$="/reopen"]',
      'form[action$="/task/delete"]'
    ].join(',');
    const forms = document.querySelectorAll(sel);
    forms.forEach(function(form) {
      form.addEventListener('submit', function() {
        try {
          const taskInput = form.querySelector('input[name="task_id"]');
          const taskId = taskInput ? taskInput.value : '';
          sessionStorage.setItem('cleanerScrollY', String(window.scrollY));
          sessionStorage.setItem('cleanerAnchor', taskId ? ('task-' + taskId) : '');
        } catch (e) {}
      }, { capture: true });
    });
  }
  attachCleanerPreserveHandlers();
})();
</script>
<script>
// Scroll zu Task-Karte wenn Hash in URL vorhanden (z.B. von WhatsApp-Link)
(function() {
  document.addEventListener('DOMContentLoaded', function() {
    // Pr√ºfe ob Hash in URL vorhanden (z.B. #task-123)
    const hash = window.location.hash;
    if (hash && hash.startsWith('#task-')) {
      const taskId = hash.replace('#task-', '');
      // Suche Task-Karte mit ID
      let el = document.getElementById('task-' + taskId);
      if (el) {
        // Warte kurz, damit die Seite vollst√§ndig geladen ist
        setTimeout(function() {
          el.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Optional: Highlight-Effekt
          el.style.transition = 'box-shadow 0.3s ease';
          el.style.boxShadow = '0 0 0 4px rgba(13, 110, 253, 0.5)';
          setTimeout(function() {
            el.style.boxShadow = '';
          }, 2000);
        }, 100);
      } else {
        // Falls Element noch nicht geladen, warte l√§nger
        setTimeout(function() {
          el = document.getElementById('task-' + taskId);
          if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            el.style.transition = 'box-shadow 0.3s ease';
            el.style.boxShadow = '0 0 0 4px rgba(13, 110, 253, 0.5)';
            setTimeout(function() {
              el.style.boxShadow = '';
            }, 2000);
          }
        }, 500);
      }
    }
  });
})();
</script>
<script>
// Modal setup
const noteModal = document.getElementById('noteModal');
noteModal.addEventListener('show.bs.modal', event => {
  const button = event.relatedTarget;
  const taskId = button.getAttribute('data-task');
  const current = button.getAttribute('data-current') || '';
  document.getElementById('noteTaskId').value = taskId;
  document.getElementById('noteText').value = current;
});

document.getElementById('saveNoteBtn').addEventListener('click', async () => {
  const taskId = document.getElementById('noteTaskId').value;
  const note = document.getElementById('noteText').value;
  const formData = new FormData();
  formData.append('task_id', taskId);
  formData.append('note', note);
  const resp = await fetch('/cleaner/{{ staff.magic_token }}/note', { method: 'POST', body: formData });
  const data = await resp.json();
  if(data.ok){
    // Update note text in card
    const cards = document.querySelectorAll('.task-card');
    cards.forEach(card => {
      const button = card.querySelector(`button[data-task="${taskId}"]`);
      if (button){
        let noteDiv = card.querySelector('.mt-2.text-muted');
        if(!noteDiv){
          noteDiv = document.createElement('div');
          noteDiv.className = 'mt-2 text-muted';
          const col = card.querySelector('.col-12');
          col.appendChild(noteDiv);
        }
        noteDiv.innerHTML = '<i class="bi bi-sticky"></i> ' + (data.note || '');
      }
    });
    const modal = bootstrap.Modal.getInstance(noteModal);
    modal.hide();
  }
});

// Live-Timer: einfache, robuste Berechnung seit Startzeit
function secondsSince(startIso){
  if(!startIso || !startIso.trim()) return 0;
  try {
    const isoString = startIso.replace(' ', 'T'); // "YYYY-MM-DD HH:MM:SS" -> ISO
    const start = new Date(isoString);
    if (isNaN(start.getTime())) return 0;
    const now = new Date();
    const diff = Math.floor((now - start) / 1000);
    return diff > 0 ? diff : 0;
  } catch(e) {
    return 0;
  }
}

function formatTimeSeconds(totalSeconds){
  if(totalSeconds < 0) totalSeconds = 0;
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  
  if (hours > 0) {
    return `${hours}:${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
  } else {
    return `${minutes}:${String(seconds).padStart(2,'0')}`;
  }
}

function updateTimers(){
  document.querySelectorAll('[id^=timer-]').forEach(el => {
    const id = el.id.split('-')[1];
    const started = el.getAttribute('data-started');
    const planned = parseInt(el.getAttribute('data-planned') || '0', 10);
    const accumulated = parseInt(el.getAttribute('data-accumulated') || '0', 10);
    
    if(!started || started === '' || started.trim() === ''){
      el.textContent = '‚è±Ô∏è 0:00';
      const remainingEl = document.getElementById('remaining-'+id);
      if(remainingEl){
        const langRemaining = remainingEl.getAttribute('data-lang-remaining') || 'noch ca.';
        const langMin = remainingEl.getAttribute('data-lang-min') || 'min';
        remainingEl.textContent = `${langRemaining} ${planned} ${langMin}`;
        remainingEl.style.color = '';
      }
      return;
    }
    
    const elapsedSeconds = secondsSince(started) + Math.max(0, accumulated) * 60;
    const elapsedMinutes = Math.floor(elapsedSeconds / 60);
    const remaining = Math.max(0, planned - elapsedMinutes);
    
    // Timer-Anzeige mit Sekunden - startet bei 0:00
    el.textContent = `‚è±Ô∏è ${formatTimeSeconds(elapsedSeconds)}`;
    
    // Verbleibende Zeit
    const remainingEl = document.getElementById('remaining-'+id);
    if(remainingEl){
      const langOver = remainingEl.getAttribute('data-lang-over') || '√úber Zeit';
      const langRemaining = remainingEl.getAttribute('data-lang-remaining') || 'noch ca.';
      const langMin = remainingEl.getAttribute('data-lang-min') || 'min';
      remainingEl.textContent = elapsedMinutes >= planned ? 
        `‚ö†Ô∏è ${langOver} (+${elapsedMinutes - planned} ${langMin})` : 
        `${langRemaining} ${remaining} ${langMin}`;
      remainingEl.style.color = elapsedMinutes >= planned ? '#dc3545' : '';
    }
  });
}
updateTimers(); // Sofort beim Laden
setInterval(updateTimers, 1000); // Update jede Sekunde f√ºr echtes live-feeling

// Heutiges Datum beim √ñffnen des Modals vorbelegen
document.addEventListener('DOMContentLoaded', function(){
  const modal = document.getElementById('newTaskModal');
  if (modal) {
    modal.addEventListener('show.bs.modal', function(){
      const dateInput = document.getElementById('c-task-date');
      if (dateInput && !dateInput.value) {
        const today = new Date();
        const y = today.getFullYear();
        const m = String(today.getMonth()+1).padStart(2,'0');
        const d = String(today.getDate()).padStart(2,'0');
        dateInput.value = `${y}-${m}-${d}`;
      }
    });
  }
  
  // Filter-Parameter automatisch zu allen Formularen hinzuf√ºgen
  const urlParams = new URLSearchParams(window.location.search);
  const showDone = urlParams.get('show_done') || '{{ show_done }}';
  const showOpen = urlParams.get('show_open') || '{{ show_open }}';
  
  const allForms = document.querySelectorAll('form[method="post"]');
  allForms.forEach(form => {
    // Pr√ºfe ob bereits hidden inputs vorhanden sind
    if (!form.querySelector('input[name="show_done"]')) {
      const inputDone = document.createElement('input');
      inputDone.type = 'hidden';
      inputDone.name = 'show_done';
      inputDone.value = showDone;
      form.appendChild(inputDone);
    }
    if (!form.querySelector('input[name="show_open"]')) {
      const inputOpen = document.createElement('input');
      inputOpen.type = 'hidden';
      inputOpen.name = 'show_open';
      inputOpen.value = showOpen;
      form.appendChild(inputOpen);
    }
  });
  
  // Tab-Navigation: URL aktualisieren bei Tab-Wechsel (optional, f√ºr bessere UX)
  const tabButtons = document.querySelectorAll('[data-bs-toggle="tab"]');
  tabButtons.forEach(button => {
    button.addEventListener('shown.bs.tab', function (e) {
      const targetId = e.target.getAttribute('data-bs-target');
      const baseUrl = '/cleaner/{{ staff.magic_token }}';
      const params = new URLSearchParams();
      
      if (targetId === '#content-all') {
        params.set('show_done', '1');
        params.set('show_open', '1');
      } else if (targetId === '#content-open') {
        params.set('show_done', '0');
        params.set('show_open', '1');
      } else if (targetId === '#content-done') {
        params.set('show_done', '1');
        params.set('show_open', '0');
      }
      
      // URL aktualisieren ohne Reload (f√ºr bessere UX)
      const newUrl = baseUrl + '?' + params.toString();
      window.history.pushState({}, '', newUrl);
    });
  });
});
</script>
<script>
// Web Push Registration (Cleaner)
async function registerPushCleaner() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window) || !('Notification' in window)) { alert('Push nicht unterst√ºtzt'); return; }
  try {
    const perm = await Notification.requestPermission();
    if (perm !== 'granted') return;
    await navigator.serviceWorker.register('/sw.js');
    const reg = await navigator.serviceWorker.ready;
    const resp = await fetch('/push/public_key');
    const { publicKey } = await resp.json();
    if (!publicKey) { alert('VAPID fehlt'); return; }
    const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: urlBase64ToUint8Array(publicKey) });
    await fetch(`/push/subscribe?staff_token={{ staff.magic_token }}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sub) });
    alert('Push aktiviert');
  } catch(e) { console.error(e); alert('Push fehlgeschlagen'); }
}
function urlBase64ToUint8Array(base64String) {
  const padding = '='.repeat((4 - (base64String.length % 4)) % 4);
  const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}
document.addEventListener('DOMContentLoaded', function(){
  const btn = document.getElementById('btnEnablePushCleaner');
  if (btn) btn.addEventListener('click', registerPushCleaner);
});
</script>
</div></body></html>
