<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<title>Serienaufgaben</title>
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Serienaufgaben</h1>
    <a class="btn btn-outline-secondary" href="/admin/{{ token }}"><i class="bi bi-arrow-left"></i> Zurück</a>
  </div>

  <div class="card mb-4">
    <div class="card-header">Neue Serie anlegen</div>
    <div class="card-body">
      <form class="row g-3" method="post" action="/admin/{{ token }}/series/add">
        <div class="col-md-6">
          <label class="form-label">Titel</label>
          <input class="form-control" name="title" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Geplante Minuten</label>
          <input class="form-control" type="number" name="planned_minutes" value="60" min="1">
        </div>
        <div class="col-12">
          <label class="form-label">Beschreibung</label>
          <textarea class="form-control" name="description" rows="2"></textarea>
        </div>
        <div class="col-md-4">
          <label class="form-label">Apartment</label>
          <select class="form-select" name="apartment_id_raw">
            <option value="">– Keines –</option>
            {% for id, name in apartments.items() %}
            <option value="{{ id }}">{{ name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Mitarbeiter (optional, für Zuweisung)</label>
          <select class="form-select" name="staff_id_raw">
            <option value="">– Keiner –</option>
            {% for s in staff %}
            <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">Start-Datum</label>
          <input class="form-control" type="date" name="start_date" required>
        </div>
        <div class="col-md-3">
          <label class="form-label">Start-Zeit</label>
          <input class="form-control" type="time" name="start_time">
        </div>
        <div class="col-md-3">
          <label class="form-label">Frequenz</label>
          <select class="form-select" name="frequency" required>
            <option value="weekly">Wöchentlich</option>
            <option value="monthly">Monatlich</option>
            <option value="yearly">Jährlich</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label">Intervall</label>
          <input class="form-control" type="number" name="interval" value="1" min="1">
        </div>
        <div class="col-md-3">
          <label class="form-label">Ende (optional)</label>
          <input class="form-control" type="date" name="end_date">
        </div>
        <div class="col-md-6">
          <label class="form-label">Wochentage (z. B. MO,WE,FR)</label>
          <input class="form-control" name="byweekday" placeholder="MO,TU,WE,TH,FR,SA,SU">
        </div>
        <div class="col-md-6">
          <label class="form-label">Monatstage (z. B. 1,15,31)</label>
          <input class="form-control" name="bymonthday" placeholder="1,15,31">
        </div>
        <div class="col-12">
          <button class="btn btn-primary" type="submit"><i class="bi bi-plus-circle"></i> Serie anlegen</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-header">Serien</div>
    <div class="table-responsive">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>ID</th><th>Titel</th><th>Frequenz</th><th>Intervall</th><th>Aktiv</th><th>Start</th><th>Zuordnung</th><th>Aktion</th>
          </tr>
        </thead>
        <tbody>
          {% for s in series %}
          <tr>
            <td>{{ s.id }}</td>
            <td>{{ s.title }}</td>
            <td>{{ s.frequency }}</td>
            <td>{{ s.interval }}</td>
            <td>
              <form method="post" action="/admin/{{ token }}/series/toggle" class="d-inline">
                <input type="hidden" name="series_id" value="{{ s.id }}">
                <button class="btn btn-sm {{ 'btn-success' if s.active else 'btn-secondary' }}">
                  {{ 'Aktiv' if s.active else 'Inaktiv' }}
                </button>
              </form>
            </td>
            <td>{{ s.start_date }} {{ s.start_time }}</td>
            <td>
              {% if s.apartment_id %}<span class="badge bg-info">Apt {{ apartments.get(s.apartment_id) }}</span>{% endif %}
              {% if s.staff_id %}<span class="badge bg-primary">{{ staff|selectattr('id','equalto',s.staff_id)|map(attribute='name')|first }}</span>{% endif %}
            </td>
            <td>
              <!-- Bearbeiten-Button öffnet Inline-Formular -->
              <button class="btn btn-sm btn-outline-primary mb-1" type="button" onclick="toggleEditForm({{ s.id }})">
                <i class="bi bi-pencil-square"></i>
              </button>
              <form method="post" action="/admin/{{ token }}/series/delete" class="d-inline" onsubmit="return confirm('Serie löschen? Optional: zukünftige Instanzen löschen.');">
                <input type="hidden" name="series_id" value="{{ s.id }}">
                <input type="hidden" name="delete_future" value="1">
                <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
              </form>
              <div id="edit-series-{{ s.id }}" class="mt-2 border rounded p-2 bg-light d-none">
                <form method="post" action="/admin/{{ token }}/series/update" class="row g-2">
                  <input type="hidden" name="series_id" value="{{ s.id }}">
                  <div class="col-12">
                    <label class="form-label mb-1">Titel</label>
                    <input class="form-control form-control-sm" name="title" value="{{ s.title }}" required>
                  </div>
                  <div class="col-12">
                    <label class="form-label mb-1">Beschreibung</label>
                    <textarea class="form-control form-control-sm" name="description" rows="2">{{ s.description or '' }}</textarea>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Apartment</label>
                    <select class="form-select form-select-sm" name="apartment_id_raw">
                      <option value="">– Keines –</option>
                      {% for id, name in apartments.items() %}
                      <option value="{{ id }}" {% if s.apartment_id==id %}selected{% endif %}>{{ name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Mitarbeiter</label>
                    <select class="form-select form-select-sm" name="staff_id_raw">
                      <option value="">– Keiner –</option>
                      {% for st in staff %}
                      <option value="{{ st.id }}" {% if s.staff_id==st.id %}selected{% endif %}>{{ st.name }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Geplante Minuten</label>
                    <input class="form-control form-control-sm" type="number" name="planned_minutes" value="{{ s.planned_minutes or 60 }}" min="1">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Start-Datum</label>
                    <input class="form-control form-control-sm" type="date" name="start_date" value="{{ s.start_date }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Start-Zeit</label>
                    <input class="form-control form-control-sm" type="time" name="start_time" value="{{ s.start_time }}">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Frequenz</label>
                    <select class="form-select form-select-sm" name="frequency">
                      <option value="weekly" {% if s.frequency=='weekly' %}selected{% endif %}>Wöchentlich</option>
                      <option value="monthly" {% if s.frequency=='monthly' %}selected{% endif %}>Monatlich</option>
                      <option value="yearly" {% if s.frequency=='yearly' %}selected{% endif %}>Jährlich</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Intervall</label>
                    <input class="form-control form-control-sm" type="number" name="interval" value="{{ s.interval }}" min="1">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label mb-1">Ende (optional)</label>
                    <input class="form-control form-control-sm" type="date" name="end_date" value="{{ s.end_date or '' }}">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label mb-1">Wochentage</label>
                    <input class="form-control form-control-sm" name="byweekday" value="{{ s.byweekday or '' }}" placeholder="MO,TU,WE,TH,FR,SA,SU">
                  </div>
                  <div class="col-md-6">
                    <label class="form-label mb-1">Monatstage</label>
                    <input class="form-control form-control-sm" name="bymonthday" value="{{ s.bymonthday or '' }}" placeholder="1,15,31">
                  </div>
                  <div class="col-12 text-end">
                    <button class="btn btn-sm btn-secondary me-2" type="button" onclick="toggleEditForm({{ s.id }})">Abbrechen</button>
                    <button class="btn btn-sm btn-primary" type="submit">Speichern</button>
                  </div>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="8" class="text-center text-muted">Keine Serien vorhanden</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
<script>
function toggleEditForm(id) {
  const el = document.getElementById('edit-series-' + id);
  if (!el) return;
  el.classList.toggle('d-none');
}
</script>
</body></html>
